import { relative, resolve } from 'path';
import { normalizeStories } from '@storybook/core-common';
import { getStorybookMain } from './getStorybookMain';
export const getStorybookMetadata = () => {
  var _main$core, _main$core$builder, _main$core$builder$op;

  const workingDir = resolve();
  const configDir = process.env.STORYBOOK_CONFIG_DIR;
  const main = getStorybookMain(configDir);
  const normalizedStoriesEntries = normalizeStories(main.stories, {
    configDir,
    workingDir
  }).map(specifier => ({ ...specifier,
    importPathMatcher: new RegExp(specifier.importPathMatcher)
  }));
  const storiesPaths = normalizedStoriesEntries.map(entry => entry.directory + '/' + entry.files).map(dir => '<rootDir>/' + relative(workingDir, dir)).join(';'); // @ts-ignore -- this is added in @storybook/core-common@6.5, which we don't depend on

  const lazyCompilation = !!(main !== null && main !== void 0 && (_main$core = main.core) !== null && _main$core !== void 0 && (_main$core$builder = _main$core.builder) !== null && _main$core$builder !== void 0 && (_main$core$builder$op = _main$core$builder.options) !== null && _main$core$builder$op !== void 0 && _main$core$builder$op.lazyCompilation);
  return {
    configDir,
    workingDir,
    storiesPaths,
    normalizedStoriesEntries,
    lazyCompilation
  };
};